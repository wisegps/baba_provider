<!--
	作者：小刘
	时间：2015-12-2
	描述：客户咨询
-->
<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
			
		<title>WiCARE</title>
		<script src="../wslib/WiStorm.js"></script>
		<script type="text/javascript" src="http://tajs.qq.com/h5?sId=500001220" charset="UTF-8" defer="defer"></script>
		<script>link("W.css")</script>
		
		<script src="../wslib/api/newWapi.js"></script>
		<style>
			body{ background-color: #EFEFF4;}
			.mui-content{z-index: 0;}
			.newList{background-color: white;padding:7px 10px 5px 10px;border-top: 1px solid #f2f2f2;}
			.child_view{background-color:#F0F0F0;min-height: 100vh;height: auto;}
			.bottom{z-index: 9999;background-color: #F9F9F9;padding: 5px 15px;bottom: 0;position: fixed;width: 100%;border-top: 1px solid #ccc;}
			.bottom input{width: 95%;margin: 0;height: 20px;padding: 15px 0;display: inline-block;text-indent: 10px;line-height: 20px;border-radius: 3px;}
			.lab{
			    width: 60px;
			    font-size: 14px;
			    display: inline-block;
			    text-align: center;
			    float: right;
			    padding: 5px 0px;
			    background-color: rgb(92, 184, 92);
			    color: #fff;
			    border-radius: 3px;
			   }
			.lab:active{color: #aaa;}
			.text{overflow: hidden;}
			.icon{height: 40px;width: 40px;float: left;margin-right: 20px;text-align: center;line-height: 40px;font-size: 25px;color: white;}
			.d_Img{width: 40px;height: 40px;}
			.icon_img{height: 40px;width: 40px;margin-left: 20px;text-align: center;line-height: 40px;font-size: 25px;color: white;}
			.fr{float: right;}
			.fl{float: left;}
			.main-count{padding: 5px 0;min-height: 55px;position: relative;}
			.new_info{font-size: 14px;overflow: hidden;}
			#news-add{padding-top: 45px;padding-bottom: 50px;}
			.time{text-align: center;font-size:12px ;margin: 5px 0;}
			
			.new_r{overflow: hidden;padding:0 50px 0 6px;border-radius: 0.4em;position: relative;}
			.tran_r{position:absolute;margin-top: 8px;width: 10px;height: 10px;background-color: white;transform: rotate(45deg);-webkit-transform:rotate(45deg);-moz-transform: rotate(45deg);-ms-transform:rotate(45deg);-o-transform:rotate(45deg);}
			.news_r{width:auto;min-height:40px;line-height: 1.5em;max-width: 100%;display: inline-block;border-radius: .3em;font-size: 15px; word-wrap: break-word;background-color: white;padding: 9px 10px 9px 15px;margin-left: 4px;}
			
			.new_l{overflow: hidden;padding:0 6px 0 50px;border-radius: 0.4em;position: relative;}
			.tran_l{right: 5px;position:absolute;margin-top: 8px;width: 10px;height: 10px;background-color:  #50B7DE;transform: rotate(45deg);-webkit-transform:rotate(45deg);-moz-transform: rotate(45deg);-ms-transform:rotate(45deg);-o-transform:rotate(45deg);}
			.news_l{line-height: 1.5em;min-height: 40px;display: inline-block;max-width: 100%;font-size: 15px;border-radius: .3em;width:auto;word-wrap: break-word;background-color: #50B7DE;color:white;padding: 9px 15px 9px 10px;margin-right: 4px;}
			.icon_img_l{height: 40px;width: 40px;margin-right: 20px;text-align: center;line-height: 40px;font-size: 25px;color: white;}
			.show_news{position: relative;}
			.show_news span{  
			    width: 1.5em;
			    height: 1.5em;
			    position: absolute;
			    background-color: #F13F40;
			    right: .5em;
			    top: 0;
			    color: white;
			    text-align: center;
			    vertical-align: top;
			    line-height: 1.5em;
			    border-radius: 100%;
			    font-size: 12px;
			 }
			 .show_news p{
				color:#ccc;margin: 0 3.2em 0 0;overflow: hidden;white-space: nowrap;height: 21px;			 	
			 }
			 .ui_auto_load{border-bottom: 1px solid #e5e4e2;text-align: center;padding: 10px;background: #fff;}
			.op{text-align: center;background-color: white;padding: .5em 0;}
			.null_tip{text-align: center;}
			.mui-content{padding-bottom: 50px;}
			.logo{
				position: absolute;
				padding: .5em;
				top: 35px;
				left: 70px;
				background: #fff;
				border: 1px solid #ccc;
			    z-index: 100;
			    border-radius: 0.3em;
			}
			.logo_img{
				display: inline-block;
			    width: 150px;
		        height: 150px;	
				}
			.logo ul{
			    list-style: none;
			    margin: .5em 0;
			    padding-left: .5em;
 			    font-size: 13px;				
			}
			.fiexd{
				position: fixed;
				width: 100vw;
				height: 100vh;
				top: 0;
				left: 0;
			    z-index: -1;
			}
		</style>
	</head>
	<body id="body">
		<header class="mui-bar mui-bar-nav">
			<a id="u_back" class="mui-icon mui-icon-left-nav mui-pull-left W_back"></a>
			<h1 id="title-user" class="mui-title">客户咨询</h1>				
		</header>
		<div class="mui-content"><div class="null_tip"><h1>NULL</h1><p>您好，您目前还没有客户发起咨询。</p></div></div>
		<div class="child_view has_nav fromRight" id="Details" style="display: none;position: fixed;overflow-y:auto;height: 100%;width: 100%;">
			<div class="mui-bar mui-bar-nav" style="z-index: 200;">
				<a id="f_back" class="mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title" id="name"></h1>				
			</div>
			<div id="news-add">
			</div>
		</div>
		<div class="bottom">
			<div class="lab">发送</div>
			<div class="text">
				<input id="new_text" type="text"  />
			</div>
		</div>
	</body>
	<script>
/**
 * 消息列表组件
 * @param {Object} data
 */
	function cl(data){
		var  obj =new WiStormUI("div");
		obj.merge(this);
		obj.className='newList';
		obj.setAttribute('data-show','Details');
		obj.setData(data);
		obj.setSpan(data.unread_count);
		obj.addEvent('click',show);
		obj.data=data;
		obj.friend_id=data.friend_id;
		return obj;
	}
	cl.prototype.setData=function (data){
		var uname=data.friend_name.trim().slice(0,1);
		var newtime = spliceDate(data.send_time);
		var a=["#428bca",'#5cb85c','#5bc0de','#f0ad4e','#d9534f'];
		this.innerHTML = '<div class="icon">'+uname+'</div><div class="new_info"><div><span class="fr" style="color:#ccc;font-size: 12px;">'+newtime+'</span><div style="overflow: hidden;"><span style="color: #676767;">'+data.friend_name+'</span></div></div><div class="show_news"><p>'+data.content+'</p></div></div>';
		var c=data.friend_id%5;
		this.querySelector('.icon').style.backgroundColor=a[c];
		this.id="W"+data.friend_id;
		this.data=data;
	}

/**
 * 当有新消息时创建span元素
 */
	cl.prototype.setSpan=function (unread_count){
		var oSpan=this.lastChild.lastChild;
		if(typeof unread_count=="number"){
			this.data.unread_count=unread_count;
		}else{
			this.data.unread_count++;
		}
		
		if(this.data.unread_count!=0){
			if(oSpan.lastChild.tagName!='SPAN'){
				var span =document.createElement('span');
				oSpan.appendChild(span);
				span.innerText=this.data.unread_count;
			}else{
				oSpan.lastChild.innerText=this.data.unread_count;
			}
			oSpan.firstChild.innerText=this.data.content;
			//通知home页的导航栏有信息
			if(top!=window){
				window.parent.newMsg();
			}
		}else{
			if(oSpan.lastChild.tagName=='SPAN'){
				oSpan.removeChild(oSpan.lastChild);
			}
		}
	}
/**
 * 更改content和时间
 */
	cl.prototype.setContent=function (data){
		this.lastChild.lastChild.firstChild.innerHTML=data.content;
		this.lastChild.firstChild.firstChild.innerHTML=spliceDate(data.create_time);
		this.data.send_time=data.create_time;
		this.data.content=data.content;
	}
/**
 *  计算时间
 * @param {Object} time
 */
	function spliceDate(time){
		var newtime = (new Date()-NewDate(time))/1000/60/60;
		if(parseInt(newtime*60)==0)
			newtime="刚刚";
		else if(newtime<1)
			newtime=parseInt(newtime*60)+"分钟前";
		else if(newtime<24)
		   	newtime=parseInt(newtime)+"小时前";
		else
			newtime=parseInt(newtime/24)+"天前";
		
		return newtime;
	}
/**
 * 接收消息组件 
 * @param {Object} data
 */
	function cs(data){
		var obj = new WiStormUI('div');
		obj.merge(this);
		obj.className='main-count';
		obj.setData(data);
		return obj;
	}
	cs.prototype.getData=function(){
		return this.data;
	}
	cs.prototype.setData=function (data){
		if(_user.cust_type==3){//如果身份为员工 获取商户的名字

			data.cust_name=dom.na;
		}else if(_user.cust_type==1 || _user.cust_type==2){
			data.cust_name=_user.cust_name;
		}
		var getTime=NewDate(data.create_time);
		var gtime=W.ls("gtime");
		gtime= new Date(gtime);
		if((getTime-gtime)/1000/60>2){
			W.setLS("gtime",getTime);
			getTime=getTime.WtoString().slice(5,16)
		}else
			getTime='';
		var a=["#428bca",'#5cb85c','#5bc0de','#f0ad4e','#d9534f'];
		var c=data.sender_id%5;
		var uname;
		data._pos='left';
		if(_user.cust_type==1){
			if(data.sender_id==_user.cust_id)
				data._pos='right';
		}else{
			if(data.sender_id==_user.seller_id)
				data._pos='right';
		}
		if(data._pos=='right'){
            //显示右边
			uname=data.cust_name.slice(0,1);
			this.innerHTML='<div class="time">'+getTime+'</div><div class="icon_img_l fr">'+uname+'</div><div class="new_l"><div class="tran_l"></div><span class="news_l fr">'+data.content+'</span></div>';			
			this.querySelector('.icon_img_l').style.backgroundColor=a[c];
		}else{
			//显示左边
			uname=W('#name').innerHTML.slice(0,1);
			this.innerHTML='<div class="time">'+getTime+'</div><div class="icon_img fl">'+uname+'</div><div class="new_r"><div class="tran_r"></div><span class="news_r">'+data.content+'</span></div>';
			this.querySelector('.icon_img').style.backgroundColor=a[c];
		}
		if(this.querySelector('.icon_img')){
			var logo=this.querySelector('.icon_img');
			logo.addEvent('click',cs.clickLogo);
		}
		this.data=data;
	}
	//点击头像显示对方资料卡片
	cs.clickLogo=function(){
		clearTimeout(dom.logoTime);
		var nodes=this.parentNode;
		if(!dom.logo){
			var param={
				cust_id:nodes.data.friend_id,
				access_token:_user.access_token
			}
			Wapi.user.get(function(res){
				if (res.status_code) {
					W.errorCode(res);
					return;
				}
				var obj,img,name,type=["无车","车主","服务商","员工","销售商"],tp,tel,mou;
				obj = new WiStormUI('div');
				obj.className='logo';
				if(res.logo)
					img=res.logo;
				res.cust_name?name=res.cust_name:name="无名客户";
				tp=type[res.cust_type];//类型
				res.mobile?tel="<a href='tel:"+res.mobile+"'>"+res.mobile:tel="<a href='tel:"+res.tel+"'>"+res.tel;
				if(!tel)
					tel='空';
				obj.innerHTML='<div class="fiexd"></div><img class="logo_img" src="'+img+'" onerror="ierror()" /><ul><li>身份：'+tp+'</li><li>名字：'+name+'</li><li>电话：'+tel+'</li></ul>';
				mou=obj.querySelector(".fiexd");
				mou.addEvent('click',logoBlur);
				dom.logo=obj;
				nodes.appendChild(obj);
			},param);
		}else{
			nodes.appendChild(dom.logo);
			dom.logo.style.display='block';
		}
	}
	//头像失去焦点
	function logoBlur(){
		W.parents(this,1).style.display='none';
	}
	//如果图片出错  显示微车联logo
	function ierror(){
		event.target.src="../img/logo.jpg";
		event.target.onerror=null;
	}	
/**
 * 文档加载完毕
 */
var news_cust_id,dom={},MAX_ID="0",settime,localnews={},MIN_ID;
	window.addEventListener("W.loginSuccess",function(){//框架的自定义事件，当页面load事件触发并且已经登录成功则会触发该事件,用于某些需要不经过登录页也可以直接访问，但是又需要用户授权登录的页面
		if(_user.cust_type==3&&(!_user.privilege||_user.privilege.ca==0)){
			location="home.html";
		}
		if(_user.cust_type==1)
			W("#title-user").innerHTML='咨询';
		dom.newlist=W(".mui-content");
		dom.newlists=W("#news-add");
		dom.details=W("#Details");
		newlist();//消息列表
		W(".lab").addEvent('click',sendnew);
		dom.bottom=W(".bottom");
		dom.bottom.style.display="none";
		getnews();
		if(_user.cust_type==3)
			getSeller();//获取商户名字
		
		W("#f_back").addEvent('click',function(){
			history.back();
		});
		if(dom.newlist.innerHTML!='')
			W(".null_tip").style.display='none';
	})
	//监听地址变化，切换view
		window.addEventListener("popstate",hide);
	/**
	 * 从消息列表滑动到具体消息
	 * @param {Object} id
	 */
			function show(){
				localnews[this.id].length=0;
				this.setSpan(0);
				W('#name').innerHTML=this.data.friend_name;
				var fid=this.friend_id;
				history.pushState(null,"customer_advisory.html?id="+fid,"customer_advisory.html?id="+fid);//	
				if(news_cust_id!=-fid){
					delete MIN_ID;
					news_cust_id=fid;
					dom.newlists.innerHTML="";
					receives();
				}else{
					news_cust_id=Math.abs(news_cust_id);
				}
				dom.details.style.display='block';		
				if(top!=window)
					plus.webview.currentWebview().parent().evalJS('W.dom.nav.style.display="none";');
				dom.bottom.style.display="block";
				setScoll();
			}
									
	
	function hide(){
		document.body.onscroll=null;
		news_cust_id=-news_cust_id;
		//dom.newlists.innerHTML="";
		dom.details.style.display='none';
		if(dom.details.className==''){//如果用户单独进入后点返回按钮  聊天页添加动画效果
			dom.details.className='child_view has_nav fromRight';
			dom.newlist.style.display='block';//把列表页展示
			dom.details.style.display='none';
		}
		if(dom.logo)
			delete dom.logo;
		if(top!=window)
			plus.webview.currentWebview().parent().evalJS('W.dom.nav.style.display="block";');
		dom.bottom.style.display="none";
	}
/**
 * 接收新消息刷新消息列表
 * 从数据库获取最后的20条数据 
 */

	function getnews(){
		var data={
			user_id:_user.seller_id,
			access_token:_user.access_token,	
			max_id:MAX_ID				
		};
		var op={
			sorts:"-chat_id",
			page:"chat_id",
			limit:"20"			
		}
	if(_user.cust_type==1)
		data.user_id=_user.cust_id;
		Wapi.chat.list(function (res){
			if (res.status_code) {
				W.errorCode(res);
				return;
			}

			if(res.data.length!=0){
				if(MAX_ID==="0"){//初始加载不执行下面代码
					MAX_ID=res.data[0].chat_id;
					settime=setTimeout(getnews,5000);
					return;
				}
				MAX_ID=res.data[0].chat_id;
				var t,clObj;
				for(var i=0;i<res.data.length;i++){
					t=localnews["W"+res.data[i].friend_id];//前面创建了空的数组  现在用friend_id判断聊天列表里是否存在这个好友
					if(t){//如果聊天列表里有这个好友
						t.push(res.data[i]);
						clObj=W("#W"+res.data[i].friend_id);//cl组件
						clObj.setContent(res.data[i]);
						if(clObj!=dom.newlist.childNodes[0])//有新消息就把该列表放在最前
							dom.newlist.insertBefore(clObj,dom.newlist.childNodes[0]);
						var prompt=_user.seller_id;
						if(_user.cust_type==1){
							prompt=_user.cust_id;
						}
						//如果是当前正在聊天的好友，并且不是自己发送的，则添加一条信息
						if(news_cust_id!=res.data[i].friend_id && res.data[i].sender_id!=prompt){
							clObj.setSpan();
						}
						dom.newlists.appendChild(new cs(res.data[i]));
						setScoll();
					}else{
						localnews["tem_W"+res.data[i].friend_id]=new Array();
						localnews["tem_W"+res.data[i].friend_id].push(res.data[i]);
						newlist();//刷新聊天列表
					}
				}
			}
			settime=setTimeout(getnews,5000);
		},data,op);
	}
/**
 * 点击时加载对应的聊天记录
 * 这里需要从后面排序而加载那里正常排序就可以
 */
	function receives(){
	var param={
		user_id:_user.seller_id,
		access_token:_user.access_token,	
		friend_id:news_cust_id,
		max_id:0				
	};
	var op={
		sorts:"-chat_id",
		page:"chat_id",
		limit:"20"			
	}
	if(_user.cust_type==1)
		param.user_id=_user.cust_id;
		Wapi.chat.list(function  (res){
			if (res.status_code) {
				W.errorCode(res);
				return;
			}
			if(res.data.length!=0){
				MIN_ID=res.data[res.data.length-1].chat_id;				
				localStorage.removeItem('gtime');
				res = res.data;
				var list= document.createDocumentFragment();
				for(var i=res.length-1;i>=0;i--){
					list.appendChild(new cs(res[i]));
				}
				dom.newlists.appendChild(list);
				setScoll();
				setTimeout(setScoll,500);
				
				//window.onscroll=getNextnews;
				var scoll=W("#Details");
				
				scoll.onscroll=getNextnews;
			}
		},param,op);
	}
/**
 * 向上加载
 */
function getNextnews(){
		var param={
			user_id:_user.seller_id,
			access_token:_user.access_token,	
			friend_id:news_cust_id,
			min_id:MIN_ID							
		}
		if(_user.cust_type==1)
			param.user_id=_user.cust_id;
			var scoll=W("#news-add");	
			var Otop = scoll.getBoundingClientRect().top; //元素顶端到可见区域顶端的距离
		if(Otop>=0){
			Wapi.chat.list(function (res){
				if (res.status_code) {
					W.errorCode(res);
					return;
				}
				res=res.data;
				var oHeight = dom.newlists.offsetHeight;
				if(res.length!=0){
					var list = document.createDocumentFragment();
					MIN_ID=res[0].chat_id;				
					for(var i=0;i<res.length-1;i++){
						list.appendChild(new cs(res[i]));
					}
					dom.newlists.insertBefore(list,dom.newlists.childNodes[0]);//把整个列表添加到页面
				}else{
					if(dom.newlists.childNodes[0].tagName!='P'){
						var op= document.createElement('p');
						op.className = 'op';
						op.innerHTML='对不起，没有更多消息了';
						dom.newlists.insertBefore(op,dom.newlists.childNodes[0]);
					}
				}
				so=W("#Details");
				so.scrollTop=(dom.newlists.offsetHeight-oHeight);//当加载完成后滚动条位置在开始的消息上
			},param)
		}
}
/**
 * 设置滚动条到底部
 */
	function setScoll(){
		var scoll=W("#Details");
		scoll.scrollTop=scoll.scrollHeight-window.innerHeight; //设置滚动条离顶部的距离是滚动条的高度
		
	}

/**
 * 消息列表
 */
		function newlist(){
			
			var data={
				user_id:_user.seller_id,			
				access_token:_user.access_token,	
			};
			if(_user.cust_type==1)
				data.user_id=_user.cust_id;
			var op={
				sorts:"-send_time"			
			};
			Wapi.relation.list(function (res){
				if (res.status_code) {
					W.errorCode(res);
					return;
				}

				if(res.data.length!=0){
						dom.newlist.firstChild.style.display='none';
						var list = document.createDocumentFragment();
						for(var i=0;i<res.data.length;i++){
							var f =res.data[i].friend_id;
							if(f>4){
								if(!localnews['W'+f]){
									list.appendChild(new cl(res.data[i]));
									localnews["W"+f]=localnews["tem_W"+f]||new Array();
									delete localnews["tem_W"+f];
								}
							}
						}
						dom.newlist.insertBefore(list,dom.newlist.childNodes[0]);
									
				}
				//判断用户与商户是否聊过天		
				if(_g.id){
					var s=W("#W"+_g.id);
					if(!s){
						if(_user.cust_type==1){//车主身份才执行，如果是商户，则不打开对话窗口
							var f =_g.id;
							var setdata={};
							var temD=new Date();
							temD.setHours(temD.getHours()-8);
							var t=temD.WtoString().split(" ");
							var str=t[0]+"T"+t[1]+".000Z";
							setdata.send_time=str;//设置发送时间
							var par={
								cust_id:_g.id,
								access_token:_user.access_token
							};
							Wapi.user.get(function(res){
								setdata.friend_name=res.cust_name;
								setdata.friend_id=f;//获取id
								setdata.content='';//发送消息
								setdata.unread_count=0;//等于0不显示红点
								if(f>4){
									if(!localnews['W'+f]){									
										dom.newlist.insertBefore(new cl(setdata),dom.newlist.childNodes[0]);
										localnews["W"+f]=localnews["tem_W"+f]||new Array();
										delete localnews["tem_W"+f];
									}
								}								
							},par);					
						}
					}else{
						dom.details.className='';
						dom.newlist.style.display='none';//把列表页隐藏
						dom.details.style.display='block';
						show.call(s);						
					}
				}			
			},data,op);
			
		}
/**
 * 发送消息
 */
	function sendnew(){
		var val= W('#new_text').value;
		//&amp;&  &#43;+
		if(val.trim()!=''){
			var data={
				user_id:_user.cust_id,
				access_token:_user.access_token,	
				cust_name:_user.cust_name,
				friend_id:news_cust_id,
				type:'0',
				content:val				
			};
			if(_user.cust_type==3)
				data.user_id=_user.seller_id;
			Wapi.chat.add(function (res){
				
				if (res.status_code) {
					W.errorCode(res);
					return;
				}
				W("#W"+news_cust_id).querySelector('.show_news').firstChild.innerHTML=val;
				dom.newlist.insertBefore(W("#W"+news_cust_id),dom.newlist.childNodes[0]);
				data.chat_id=res.chat_id;
				MAX_ID=res.chat_id;
			},data);
			//"2015-12-15 09:58:17";
			var temD=new Date();
			temD.setHours(temD.getHours()-8);
			var t=temD.WtoString().split(" ");
			var str=t[0]+"T"+t[1]+".000Z";
			data.create_time=str;//"2015-12-14T09:50:47.162Z"			dom.newlists.appendChild(new cs(data));			
			data.sender_id=_user.seller_id;
			if(_user.cust_type==1)
				data.sender_id=_user.cust_id;
			dom.newlists.appendChild(new cs(data));
			var scoll=W("#Details");
			scoll.scrollTop=scoll.scrollHeight; //设置每次发送  滚动条离顶部的距离是滚动条的高度
			W('#new_text').value='';
		}
	}
	//如果是员工  获取商户的名字
	function getSeller(){
		var data={
			cust_id:_user.seller_id,
			access_token:_user.access_token
		};
		Wapi.user.get(function(res){
			dom.na=res.cust_name;
		},data);
	}
</script>
</html>
