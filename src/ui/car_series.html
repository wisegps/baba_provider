<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>选择车型</title>
		<script src="../../wslib/WiStorm.js?nologin"></script>

		<script>
			link("W.css")
		</script>
		<script>
			link("ui.css")
		</script>

		<script src="../../wslib/api/WVehicleApi.js" defer="defer"></script>
	</head>

	<body style="overflow: auto;height: 100%;">
		<header class="mui-bar mui-bar-nav onshadow">
			<a class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">选择车型</h1>
			<div style="padding: 0 .5em;text-align: center;background-color: #f6f6f6;">
					<span class="ico ico_search" style="z-index:2;position: absolute;left: 1.1em;top: 1em;"></span>
					<input type="search" id="search_text" placeholder="请输入关键字" onkeyup="searchSeries()">
			</div>
		</header>
		<div>
			<div class="main" id="main_div"></div>
			<div class="main" id="search_div"></div>
		</div>

		<div class="child_view fromSmall hide" id="series">
			<div class="mui-bar mui-bar-nav onshadow">
				<a class="mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">选择车型</h1>
			</div>
			<div class="main" id="series_main"></div>
		</div>

		<div class="child_view fromSmall hide" id="car_type">
			<div class="mui-bar mui-bar-nav onshadow">
				<a class="mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">选择车款</h1>
			</div>
			<div class="main"></div>
		</div>
	</body>
	<script type="text/javascript">
		var _imageUrl_= "http://img.wisegps.cn/logo/";
		var car={};
		window.onload=function(){
			W("header>.mui-icon-left-nav").addEvent("click",function(){
				window.parent.ui_carSeries.box.hide();
			});
			var b=W("div>.mui-icon-left-nav",true);
			for(var i=0;i<b.length;i++){
				b[i].addEvent("click",function(){
					W.parents(this,".child_view").style.display="none";
				});
			}
		  W.vehicleApi.getBrands(getCarBrand);//获取车的品牌列表
		
		  //W("#range").addEvent("touchstart",letterS).addEvent("touchmove",letterM).addEvent("touchend",letterE);
		}
		function getCarBrand(res){//获取汽车品牌
		  window.Bjson=res;
		  var F="";
		  //var Fs="";
		  var img;
		  var body=W("#main_div");
		  for(var i=0;i<Bjson.length;i++){
		    F=Bjson[i].t_spell;
		    //Fs+="<t>"+F+"</t><br>";
		    var div=document.createElement("div");
		    div.innerHTML='<div class="T" id="'+Bjson[i].t_spell+'">'+Bjson[i].t_spell+'</div>';
		    for(var j=i;j<Bjson.length&&Bjson[j].t_spell==F;j++){
		      if(Bjson[j].url_icon)img=_imageUrl_+Bjson[j].url_icon;
		      else img="../../img/icon_car_moren.png";
		      div.innerHTML+='<div class="car" id="id_'+Bjson[j].id+'" onclick="chooseT(this)"><img src="'+img+'">'+Bjson[j].name+'</div>';
		    }
		    body.appendChild(div);
		    i=j-1;
		  }
		  //W("#range").innerHTML=Fs;
		}
		
		function chooseT(h){//选择该品牌，获取该品牌车型，或者该车型下的车款
		  var Tid=W.parents(h,".main").getAttribute("id");//判断是选择车型还是车款
		  var id=h.id.slice(3);
		  var name=W.trim(h.innerText);
		  var aUrl="";
		  if(Tid!="series_main"){
		    car.brandId=id;
		    car.brand=name;
		    W.vehicleApi.getSeriess(getSeriesOrType,id);
		  }else{
		    car.series=name;
		    car.seriesId=id;
		    W.vehicleApi.getTypes(getSeriesOrType,id);
		  }
		  
		function getSeriesOrType(json){
		      if(json.status_code){
		        statusCode(json.status_code);
		        if(json.err_msg){
		          alert("发生错误："+json.err_msg+"；错误码:"+json.status_code);
		        }
		      }else{
		        var Did,html="";
		        if(!json.length){
		          car.typeId=car.seriesId;
		          car.type=car.series;
		          window.parent.ui_carSeries.finish(car);
		          return;
		        }
		        if(Tid!="series_main"){
		          Did="series";
		          for (var i=json.length-1;i>=0;i--) {
		            html+="<div class='car' onclick='chooseT(this)' id='id_"+json[i].id+"'>"+json[i].show_name+"</div>";
		          };
		        }else{
		          Did="car_type";
		          for (var i=json.length-1;i>=0;i--) {
		            html+="<div class='car' onclick='chooseType(this)' id='id_"+json[i].id+"'>"+json[i].go_name+" "+json[i].name+"</div>";
		          };
		        }
		        W("#"+Did+" .main").innerHTML=html;
		        W("#"+Did+">.mui-bar-nav>.mui-title").innerText=name;
		        W("#"+Did).style.display="block";
		      }
		    }
		}
		function chooseType(h){//选择完车款返回给父页面，调用父页面的ui_resultCar方法
		  var id=h.id.slice(3);
		  var name=W.trim(h.innerText);
		  car.typeId=id;
		  car.type=name;
		  window.parent.ui_carSeries.finish(car);
		}

		function searchSeries(){
		  //搜索
		  var val=event.target.value;
		  var str=W.trim(val);
		  W.dom.search_div=W("#search_div");
		  if(str==""||!str){
		    W.dom.search_div.style.display='none';
		    return;
		  }
		  var exp=new RegExp(str,"i");
		  var tempHtml=""
		  for (var i = Bjson.length - 1; i >= 0; i--) {
		    if(Bjson[i].name.search(exp)!=-1){
		      tempHtml+=W("#id_"+Bjson[i].id).outerHTML;
		    }
		  };
		  
		  W.dom.search_div.innerHTML=tempHtml;
		  W.dom.search_div.style.display="block";
		}
	</script>
	<style type="text/css">
	#main_div{padding-top: 85px;}
		#search_div{position: absolute;z-index: 3;top: 0;background-color: #fff;display: none}
		  #range{position: fixed;z-index: 2;width: 1.5em;height: 100%;right: 1em;text-align: center;display: flex;flex-direction: column;    padding-top: 44px;
		    top: 0;}
		  #range>t{flex:1;}
		  .main{position: relative;width: 100%;height: 100%;overflow-y: auto;padding-top: 44px;}
		  #first_letter{display: none}
		  #search_text{width: 100%;padding-left: 2.2em;background: #fff;}
		  body{background-color: #efefef;}
		  .T{background-color: #D1EAF9;padding: .3em .8em;}
		  .car{padding: .3em .8em;border-bottom: 1px solid #ccc;background-color: #fff;line-height: 2em;}
		  .car img{width: 2em;height: 2em;margin-right: 1em;vertical-align: bottom;}
		  .child_view{position: fixed;}
	</style>

</html>