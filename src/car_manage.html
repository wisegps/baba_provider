<!--
	作者：小吴
	时间：2015-11-10
	描述：车辆管理页面,目前用于展示框架的使用，会尽量详细的写各种注释
-->
<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
			
		<title>WiCARE商户版</title>
		<!--必须最先引入WiStorm.js文件-->
		<script src="../wslib/WiStorm.js"></script>
		<script type="text/javascript" src="http://tajs.qq.com/h5?sId=500001220" charset="UTF-8" defer="defer"></script>
		<!--使用link()引入css文件，无需写路径，直接写文件名即可,尽量少引入css，样式如果少（小于10k为少），
		可以直接写在style元素里，放到body元素后面-->
		<script>link("W.css")</script>
		<script>link("ui.css")</script>
		
		<!--其他js文件需在css文件后面引入，如果是在加载完页面之后才会用到的，使用defer属性异步加载;或者直接放到body后面；
			同样尽量少引入js文件；
			现在接口可能需要你们自己封装，参考wslib/api/WUserApi.js里的封装方式
			-->
		<script src="../wslib/api/Wapi.js" defer="defer"></script>
		<script src="ui/ui.js"></script>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<a class="mui-icon w_icon icon_add mui-pull-right" href="customer_add.html"></a>
			<h1 class="mui-title">车辆管理</h1>
		</header>
		<div class="mui-content">
			<div class="mui-input-row mui-search">
				<input type="search" class="mui-input-clear" id="search_input" placeholder="输入车牌号查询车辆">
			</div>
			<div id="search_list"></div>
			<div><p style="text-align: center;margin: 5px 0;">您当前已建档车辆为<span id="total"></span>台</p></div>
			<div id="car_list">
				<div class="null_tip">
					<h1>NULL</h1>
					<p>您好，您目前还没有添加用户车辆，<a href="customer_add.html">添加用户</a>车辆可以方便您对车辆进店历史的查找。</p>
				</div>
			</div>
		</div>
	</body>
	<style>
		body{background-color: #EFEFF4;}
	</style>
	<script>
		function cv(data){
			var obj=new WiStormUI("div");//创建一个div组件
			
			obj.merge(this);//将原型cv.prototype中的方法赋予当前obj
			
			obj.className="ui_car_d";//设置div的class属性
			
			obj.setData(data);//设置obj的内容,setData()在下面cv.prototype中定义
			
			return obj;//最后记得要返回组件
		}
		//给组件添加对象方法
		cv.prototype.getData=function(){
			return this.data;
		}
		
		cv.prototype.setData=function(data){
			var text=data.device_id?"已安装设备":"无设备用户";
			var last_arrive;
			if(data.last_arrive_time)
				last_arrive=NewDate(data.last_arrive_time).WtoString().slice(5,-3);
			else if(data.business_status==1){
				last_arrive=NewDate(data.create_time).WtoString().slice(5,-3);
			}else
				last_arrive="未到店";
			this.innerHTML='<table><tr><th><img src="http://img.wisegps.cn/logo/m_'+data.car_brand_id+'_100.png" onerror=\'javascript:this.src="../img/icon_car_moren.png"\'><span name="value">'+data.obj_name+'</span></th><th name="tip">'+text+'</th></tr><tr><td><span class="name">客户名称:</span><span class="value">'+data.cust_name+'</span></td><td><span class="name">车型:</span><span class="value">'+data.car_type+'</span></td></tr><tr><td><span class="name">最后到店:</span><span class="value">'+last_arrive+'</span></td><td><span class="name">车架号:</span><span class="value">'+data.frame_no+'</span></td></tr></table><footer><button type="button" class="mui-btn mui-btn-warning edit">完善资料</button></footer>';
			
			var a=this.querySelector(".edit");
			a.addEvent("click",cv.editData);//给其中的按钮添加点击事件监听，使用cv.editData来处理点击事件
			
			if(data.business_status!=1){
				this.querySelector("footer").appendChild(new ui_checkInBtn(data));
			}
			this.querySelector("table").addEvent("click",cv.toDetail).obj_id=data.obj_id;
			
			this.data=data;//直接把数据缓存进入组件（按需求，如果数据是需要重复用的就这样缓存）
		}
		
		/**
		 * 这种定义方式与上面的cv.prototype不一样，只是单纯的定义一个方法而已，不会被对象使用；
		 * 使用时直接   cv.editData();   这样使用，好处是节省命名空间，同时表示了方法与组件之间有联系；
		 * 阅读起来更方便;
		 * 如这个方法是被组件内 “完善资料”按钮所调用的，使用在setData时会添加为该按钮的事件处理器
		 */
		cv.editData=function(){
			var p=W.parents(this,2);
			W.setLS("cusAdd_data",p.data);
			top.location="customer_add.html?intent=edit&params=cusAdd_data";
		}
		
		cv.toDetail=function(){
			var tem="?obj_id="+this.obj_id;
			location="car_details.html"+tem;
		}
		
		var dom={};
		dom.searchList=W("#search_list");
		dom.total=W("#total");
		//监听 html加载完成事件
		window.addEventListener("DOMContentLoaded",function(){
			if(_user.cust_type==3&&(!_user.privilege||_user.privilege[3]=="0")){
				location="home.html";
			}
			W("#search_input").addEvent("keyup",searchInput).addEvent("blur",function(){
				if(!this.value){
					dom.carList.style.display="block";
					dom.searchList.style.display="none";
				}
			});
			
			var data={
				seller_id:_user.seller_id,
				access_token:_user.access_token
			}
			//调用接口，获取用户车辆,并绘制到页面上
			var op={fields:"maintain_last_mileage,maintain_last_date,nick_name,cust_name,obj_id,cust_id,obj_name,device_id,car_brand_id,car_brand,car_series_id,car_series,car_type_id,car_type,frame_no,maintain_last_mileage,mileage,arrive_count,evaluate_count,last_arrive_time,business_status,evaluate_level,create_time"}
			W.userApi.getVehicleList(makeCarList,data,op);
			
			setTimeout(function(){//为了解决在ios下微信中从车辆详情返回本页会直接触发本页的返回按钮的bug
				W(".mui-icon-left-nav").addEvent("click",function(){location="home.html"});
			},1000);
		});

		function makeCarList(res) {
			if (res && res.status_code) {
				W.errorCode(res);
				return;
			}
			dom.total.innerText=res.total;
			if (!dom.carList)
				dom.carList = W("#car_list"); //缓存经常使用的元素;W()为元素选择器，使用css选择规则，有两个参数，具体查看WiStorm.js
			var list = document.createDocumentFragment();
			var cars = res.data;
			if(cars.length){
				W(".null_tip").style.display="none";
			}
			var data = dom.carList.data||new Array();
			var MAX_ID=dom.carList.max_id||0;
			for (var i = cars.length - 1; i >= 0; i--) {
				list.appendChild(new cv(cars[i])); //创建一个cv组件，并添加到DocumentFragment里
				if(cars[i].obj_id>MAX_ID)
					MAX_ID=cars[i].obj_id;
			}
			dom.carList.data=data.concat(cars);
			if(res.total>dom.carList.data.length){
				dom.carList.max_id=MAX_ID;
				var autoLoad;
				if(dom.carList.autoLoad){
					autoLoad=dom.carList.autoLoad;
				}else if(WiStorm.agent.ios)
					autoLoad=new ui_autoLoad(W(".mui-content"),_load);
				else
					autoLoad=new ui_autoLoad(document,_load);
				
				autoLoad.param={
					seller_id:_user.seller_id,
					access_token:_user.access_token,
					max_id:MAX_ID
				}
				list.appendChild(autoLoad);
				dom.carList.autoLoad=autoLoad;
			}else if(dom.carList.autoLoad){
				//删除自动加载组件,释放内存
				dom.carList.autoLoad.remove();
				delete dom.carList.autoLoad;
			}
			dom.carList.appendChild(list); //把整个列表添加到页面
		}
		
		//自动加载下一页
		function _load(){
			W.userApi.getVehicleList(makeCarList,this.param);
		}
		
		//输入搜索框时触发，搜索车牌号
		function searchInput(){
			var val=this.value;
			if(val==""){
				dom.carList.style.display="block";
				dom.searchList.style.display="none";
				return;
			}
			if(val.length<3){
				return;
			}
			var data={
				seller_id:_user.seller_id,
				max_id:"0",
				access_token:_user.access_token,
				obj_name:val
			}
			W.userApi.searchCustomerVehicle(showSearch,data);
		}
		function showSearch(res){
			if (res && res.status_code) {
				W.errorCode(res);
				return;
			}
			var cars=res.data;
			dom.searchList.innerHTML="";
			dom.carList.style.display="none";
			if(res.total){
				dom.searchList.style.display="block";
			}else{
				dom.searchList.innerHTML='<div class="ui_car_d" style="text-align: center;"><a href="customer_add.html?obj_name='+W("#search_input").value+'"><span class="w_icon icon_add"></span><span>新增客户</span></a></div>';
				return;
			}
			
			var list=document.createDocumentFragment();
			
			for(var i=cars.length-1;i>=0;i--){
				list.appendChild(new cv(cars[i]));//创建一个cv组件，并添加到DocumentFragment里
			}
			dom.searchList.appendChild(list);//把整个列表添加到页面
		}
		
		//至此，一个页面就基本完成了
	</script>
</html>